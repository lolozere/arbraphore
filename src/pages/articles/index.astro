---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { slugify } from '../../lib/slug';
import { formatDateFR, normalizeMediaPath } from '../../lib/media';
import { resolveArticleImages } from '../../lib/featured-image';
import { splitDescription } from '../../lib/description';

const all = (await getCollection('articles'))
  .filter(e => !e.data.draft)
  .sort((a,b) => b.data.date.valueOf() - a.data.date.valueOf());

const tags = Array.from(new Set(all.flatMap(a => a.data.tags || []))).sort((a,b)=>a.localeCompare(b));
const categories = Array.from(new Set(all.flatMap(a => a.data.categories || []))).sort((a,b)=>a.localeCompare(b));
---
<BaseLayout title="Articles" description="Tous les articles (triés par date)">
  <div class="page">
    <div class="inner">
      <h1>Articles</h1>

      <div class="filters">
        <label class="filter">
          <span class="muted">Catégories</span>
          <select id="catSel">
            <option value="">Toutes</option>
            {categories.map(c => <option value={slugify(c)}>{c}</option>)}
          </select>
        </label>
        <label class="filter">
          <span class="muted">Tags</span>
          <select id="tagSel">
            <option value="">Tous</option>
            {tags.map(t => <option value={slugify(t)}>{t}</option>)}
          </select>
        </label>
      </div>

      <div id="list">
        {all.map((a) => {
          const representative = resolveArticleImages(a).representative;
          const bodyClass = representative
            ? 'article-body article-body--with-thumb'
            : 'article-body';
          return (
            <article
              class="card article-card"
              data-tags={a.data.tags.map(slugify).join(' ')}
              data-cats={a.data.categories.map(slugify).join(' ')}
            >
              <div class={bodyClass}>
                <header class="article-head">
                  <a class="article-title" href={`/articles/${a.slug}`}>
                    <h2>{a.data.title}</h2>
                  </a>
                  <br />
                  <time class="article-date" datetime={a.data.date.toISOString()}>
                    {formatDateFR(a.data.date)}
                  </time>
                </header>
                {representative && (
                  <a class="article-thumb" href={`/articles/${a.slug}`} aria-label={`Lire ${a.data.title}`}>
                    <img
                      src={normalizeMediaPath(representative.path)}
                      alt={representative.alt ?? a.data.title}
                      loading="lazy"
                    />
                  </a>
                )}
                <div class="article-description">
                  {splitDescription(a.data.description).map((paragraph) => (
                    <p class="muted" set:html={paragraph} />
                  ))}
                </div>
                <div class="article-taxonomies">
                  {a.data.categories?.map((cat) => (
                    <a class="pill tiny cat" href={`/categories/${slugify(cat)}`}>{cat}</a>
                  ))}
                  {a.data.tags?.map((tag) => (
                    <a class="pill tiny tag" href={`/tags/${slugify(tag)}`}>{tag}</a>
                  ))}
                </div>
              </div>
            </article>
          );
        })}
      </div>

      <script type="module">
        const catSel = document.getElementById('catSel');
        const tagSel = document.getElementById('tagSel');
        const cards = Array.from(document.querySelectorAll('#list [data-tags]'));

        function apply(){
          const c = catSel.value;
          const t = tagSel.value;
          cards.forEach(el => {
            const okC = !c || (el.dataset.cats || '').split(/\s+/).includes(c);
            const okT = !t || (el.dataset.tags || '').split(/\s+/).includes(t);
            el.style.display = (okC && okT) ? '' : 'none';
          });
        }
        catSel?.addEventListener('change', apply);
        tagSel?.addEventListener('change', apply);
      </script>
    </div>
  </div>
</BaseLayout>
