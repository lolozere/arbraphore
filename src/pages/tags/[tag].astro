---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { slugify } from '../../lib/slug';
import { formatDateFR, normalizeMediaPath } from '../../lib/media';
import { resolveArticleImages } from '../../lib/featured-image';
import { splitDescription } from '../../lib/description';

export async function getStaticPaths() {
  const all = (await getCollection('articles')).filter(e => !e.data.draft);
  const tagSet = new Set(all.flatMap(a => (a.data.tags || []).map(slugify)));
  return Array.from(tagSet).map(tag => ({ params: { tag } }));
}

const { tag } = Astro.params;
const all = (await getCollection('articles'))
  .filter(e => !e.data.draft && (e.data.tags || []).map(slugify).includes(tag))
  .sort((a,b)=>b.data.date.valueOf()-a.data.date.valueOf());

const label = (all[0]?.data.tags || []).find(t => slugify(t)===tag) || tag;
---
<BaseLayout title={`Tag: ${label}`} description={`Articles taggÃ©s ${label}`}>
  <div class="page"><div class="inner">
    <h1>Tag : {label}</h1>
    <p><a class="muted" href={`/rss/tags/${tag}.xml`}>RSS pour ce tag</a></p>

    <div id="list">
      {all.map((a) => {
        const representative = resolveArticleImages(a).representative;
        const bodyClass = representative
          ? 'article-body article-body--with-thumb'
          : 'article-body';
        return (
          <article class="card article-card">
            <div class={bodyClass}>
              <header class="article-head">
                <a class="article-title" href={`/articles/${a.slug}`}>
                  <h2>{a.data.title}</h2>
                </a>
                <br />
                <time class="article-date" datetime={a.data.date.toISOString()}>
                  {formatDateFR(a.data.date)}
                </time>
              </header>
              {representative && (
                <a class="article-thumb" href={`/articles/${a.slug}`} aria-label={`Lire ${a.data.title}`}>
                  <img
                    src={normalizeMediaPath(representative.path)}
                    alt={representative.alt ?? a.data.title}
                    loading="lazy"
                  />
                </a>
              )}
              <div class="article-description">
                {splitDescription(a.data.description).map((paragraph) => (
                  <p class="muted" set:html={paragraph} />
                ))}
              </div>
              <div class="article-taxonomies">
                {a.data.categories?.map((cat) => (
                  <a class="pill tiny cat" href={`/categories/${slugify(cat)}`}>{cat}</a>
                ))}
                {a.data.tags?.map((tag) => (
                  <a class="pill tiny tag" href={`/tags/${slugify(tag)}`}>{tag}</a>
                ))}
              </div>
            </div>
          </article>
        );
      })}
    </div>
  </div></div>
</BaseLayout>
