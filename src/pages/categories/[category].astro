---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { slugify } from '../../lib/slug';
import { formatDateFR, normalizeMediaPath } from '../../lib/media';

export async function getStaticPaths() {
  const all = (await getCollection('articles')).filter(e => !e.data.draft);
  const catSet = new Set(all.flatMap(a => (a.data.categories || []).map(slugify)));
  return Array.from(catSet).map(category => ({ params: { category } }));
}

const { category } = Astro.params;
const all = (await getCollection('articles'))
  .filter(e => !e.data.draft && (e.data.categories || []).map(slugify).includes(category))
  .sort((a,b)=>b.data.date.valueOf()-a.data.date.valueOf());

const label = (all[0]?.data.categories || []).find(c => slugify(c)===category) || category;
---
<BaseLayout title={`Catégorie: ${label}`} description={`Articles dans ${label}`}>
  <div class="page"><div class="inner">
    <h1>Catégorie : {label}</h1>
    <p><a class="muted" href={`/rss/categories/${category}.xml`}>RSS pour cette catégorie</a></p>

    <div id="list">
      {all.map((a) => (
        <article class="card article-card">
          <a class="article-thumb" href={`/articles/${a.slug}`} aria-label={`Lire ${a.data.title}`}>
            <img src={normalizeMediaPath(a.data.image)} alt={a.data.imageAlt} loading="lazy" />
          </a>
          <div class="article-body">
            <a class="article-title" href={`/articles/${a.slug}`}>
              <h2>{a.data.title}</h2>
            </a>
            <time class="article-date" datetime={a.data.date.toISOString()}>{formatDateFR(a.data.date)}</time>
            <a class="article-description" href={`/articles/${a.slug}`}>
              <p class="muted">{a.data.description}</p>
            </a>
            <div class="article-taxonomies">
              {a.data.categories?.map((cat) => (
                <a class="pill tiny cat" href={`/categories/${slugify(cat)}`}>{cat}</a>
              ))}
              {a.data.tags?.map((tag) => (
                <a class="pill tiny tag" href={`/tags/${slugify(tag)}`}>{tag}</a>
              ))}
            </div>
          </div>
        </article>
      ))}
    </div>
  </div></div>
</BaseLayout>
